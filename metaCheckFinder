import os
import re
import csv
import subprocess
import uuid
from datetime import datetime

def run_msfconsole_with_resource(resource_content):
    resource_file_name = f'temp_resource_{str(uuid.uuid4())}.rc'
    with open(resource_file_name, 'w') as resource_file:
        resource_file.write(resource_content)

    msfconsole = subprocess.Popen(['msfconsole', '-r', resource_file_name], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    stdout, stderr = msfconsole.communicate()
    os.remove(resource_file_name)

    if msfconsole.returncode != 0:
        raise Exception(f"Error running msfconsole command: {stderr}")
    return stdout

def search_cve_with_check(cve):
    resource_content = f'search cve:{cve} check:yes\nexit\n'
    return run_msfconsole_with_resource(resource_content)

def process_cve_file(file_path):
    with open(file_path, 'r') as file:
        cve_list = file.readlines()

    results = []
    
    for cve in cve_list:
        cve = cve.strip()
        if cve:
            print(f"Searching for: {cve}")
            print("=============")
            result = search_cve_with_check(cve)
            module_lines = []
            for line in result.splitlines():
                if "Matching Modules" in line:
                    print(line)
                elif re.match(r'^\s{2,}\d+\s+([a-zA-Z_]+\/[a-zA-Z_]+\/[a-zA-Z_]+)', line):
                    module_lines.append(line)
                    print(line)
                elif re.match(r'^\s{2,}[a-zA-Z]', line) and not line.startswith("  "):
                    print(line)
            if not module_lines:
                print("No Checks Found")
            print("=============")
            results.append((cve, module_lines))

    # Save the results to a CSV file
    os.makedirs("results", exist_ok=True)
    today = datetime.now().strftime("%Y-%m-%d")
    csv_file = f'results/cve_checks_{today}.csv'
    
    with open(csv_file, 'w', newline='') as csvfile:
        csv_writer = csv.writer(csvfile)
        csv_writer.writerow(['CVE', 'Matching Modules'])
        for cve, modules in results:
            if modules:
                for module in modules:
                    csv_writer.writerow([cve, module.strip()])
            else:
                csv_writer.writerow([cve, "No Checks Found"])

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 2:
        print("Usage: python run.py <cve_list_file>")
        sys.exit(1)
    process_cve_file(sys.argv[1])
